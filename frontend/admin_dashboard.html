<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenObasket - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        /* Header */
        .admin-header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .admin-logo {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-logo i {
            color: #f1c40f;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-btn, .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-btn:hover, .logout-btn:hover {
            background: white;
            color: #2ecc71;
        }

        /* Dashboard Content */
        .dashboard-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2rem;
            color: #2ecc71;
            margin-bottom: 0.5rem;
        }

        .dashboard-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.products { background: #3498db; }
        .stat-icon.orders { background: #e67e22; }
        .stat-icon.revenue { background: #2ecc71; }
        .stat-icon.users { background: #9b59b6; }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }

        /* Product Management */
        .section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
        }

        .add-product-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .add-product-btn:hover {
            background: #27ae60;
        }

        /* Product Table */
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .products-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }

        .product-name {
            font-weight: 600;
        }

        .product-price {
            color: #2ecc71;
            font-weight: bold;
        }

        .product-stock {
            font-weight: 600;
        }

        .stock-low { color: #e74c3c; }
        .stock-medium { color: #f39c12; }
        .stock-high { color: #2ecc71; }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .visible-btn {
            background: #2ecc71;
            color: white;
        }

        .hidden-btn {
            background: #95a5a6;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .visibility-status.visible {
            color: #2ecc71;
        }

        .visibility-status.hidden {
            color: #95a5a6;
        }

        /* Notifications Styles */
        .notification-item {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .notification-item.unread {
            border-left: 4px solid #e67e22;
            background: #fff8f0;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .notification-title {
            font-weight: bold;
            color: #2ecc71;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification-time {
            font-size: 0.8rem;
            color: #666;
        }

        .notification-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .notification-customer,
        .notification-order {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
        }

        .notification-customer h4,
        .notification-order h4 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .notification-detail {
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
        }

        .notification-total {
            font-weight: bold;
            color: #2ecc71;
            font-size: 1rem;
        }

        .order-items-section {
            margin-top: 1rem;
            background: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            padding: 1rem;
        }

        .order-items-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.85rem;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.2rem;
        }

        .item-details {
            color: #666;
            font-size: 0.8rem;
        }

        .item-quantity-price {
            text-align: right;
            color: #2ecc71;
            font-weight: 600;
        }

        .view-details-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .view-details-btn:hover {
            background: #2980b9;
        }

        .mark-read-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .mark-read-btn:hover {
            background: #2980b9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.3rem;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-help {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
            display: block;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn-primary {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary:hover { background: #27ae60; }
        .btn-secondary:hover { background: #7f8c8d; }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #2ecc71; }
        .notification.error { background: #e74c3c; }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .products-table {
                font-size: 0.8rem;
            }

            .product-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="header-content">
            <div class="admin-logo">
                <i class="fas fa-leaf"></i>
                GreenObasket Admin
            </div>
            <nav class="admin-nav">
                <a href="/" class="nav-btn" target="_blank">
                    <i class="fas fa-external-link-alt"></i>
                    View Store
                </a>
                <a href="/admin/logout" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </nav>
        </div>
    </header>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Welcome to GreenObasket Admin</h1>
            <p class="dashboard-subtitle">Manage your premium grocery store</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon products">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalProducts">0</h3>
                    <p>Total Products</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orders">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalOrders">0</h3>
                    <p>Total Orders</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon revenue">
                    <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalRevenue">₹0</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
            <div class="stat-card" onclick="toggleNotifications()" style="cursor: pointer;">
                <div class="stat-icon users" style="background: #e67e22;">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="stat-info">
                    <h3 id="unreadNotifications">0</h3>
                    <p>New Orders</p>
                </div>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="section" id="notificationsPanel" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Recent Order Notifications</h2>
                <button class="add-product-btn" onclick="markAllNotificationsRead()" style="background: #3498db;">
                    <i class="fas fa-check-double"></i>
                    Mark All Read
                </button>
            </div>
            <div id="notificationsList">
                <!-- Notifications will be loaded here -->
            </div>
        </div>

        <!-- Orders Management Section -->
        <div class="section" id="ordersPanel">
            <div class="section-header">
                <h2 class="section-title">Order Management</h2>
                <button class="add-product-btn" onclick="refreshOrders()" style="background: #3498db;">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Orders
                </button>
            </div>
            <div id="ordersList">
                <!-- Orders will be loaded here -->
            </div>
        </div>

        <!-- Product Management Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Product Management</h2>
                <button class="add-product-btn" onclick="openAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Add New Product
                </button>
            </div>
            <div class="products-container">
                <table class="products-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Rating</th>
                            <th>Visibility</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Product</h3>
                <button class="close-modal" onclick="closeProductModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-input" id="productName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="productCategory" required>
                        <option value="">Select Category</option>
                        <option value="fruits">Fresh Fruits</option>
                        <option value="vegetables">Organic Vegetables</option>
                        <option value="dairy">Dairy & Fresh</option>
                        <option value="beverages">Beverages</option>
                        <option value="spices">Spices & Herbs</option>
                        <option value="oils">Organic Oils</option>
                        <option value="nuts">Nuts & Dry Fruits</option>
                        <option value="pickles">Pickles & Condiments</option>
                        <option value="snacks">Healthy Snacks</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Price (₹)</label>
                    <input type="number" class="form-input" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Weight/Size</label>
                    <input type="text" class="form-input" id="productWeight" placeholder="e.g. 1kg, 500ml, 250g" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Stock Quantity</label>
                    <input type="number" class="form-input" id="productStock" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rating</label>
                    <input type="number" class="form-input" id="productRating" min="1" max="5" step="0.1" value="4.0" required>
                    <small class="form-help">Product rating (1-5 stars)</small>
                </div>

                <!-- New Quantity Type Section -->
                <div class="form-group">
                    <label class="form-label">Quantity Type</label>
                    <select class="form-select" id="quantityType" required onchange="updateQuantityLimits()">
                        <option value="grams">KG (Weight based)</option>
                        <option value="pieces">Numbers (Count based)</option>
                    </select>
                    <small class="form-help">Choose how customers will order this product</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Minimum Quantity</label>
                        <input type="number" class="form-input" id="minQuantity" placeholder="Min order quantity" required>
                        <small class="form-help" id="quantityHint">Minimum quantity customers can order</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Maximum Quantity</label>
                        <input type="number" class="form-input" id="maxQuantity" placeholder="Max order quantity" required>
                        <small class="form-help">Maximum quantity per order</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Image URL</label>
                    <input type="text" class="form-input" id="productImage" placeholder="Product image path" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="productDescription" placeholder="Product description" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="productVisible" checked>
                        <span>Visible to customers</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeProductModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="submitBtn">Add Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        let products = [];
        let editingProductId = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadStats();
            loadNotifications();
            
            // Auto-refresh notifications every 30 seconds
            setInterval(loadNotifications, 30000);
        });

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch('/api/admin/products/all');
                const data = await response.json();
                if (data.success) {
                    products = data.products;
                    renderProductsTable();
                }
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('Error loading products', 'error');
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalProducts').textContent = data.stats.total_products;
                    document.getElementById('totalOrders').textContent = data.stats.total_orders;
                    
                    // Calculate total revenue from orders (placeholder)
                    document.getElementById('totalRevenue').textContent = '₹' + (data.stats.total_orders * 150).toLocaleString();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch('/api/admin/notifications');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('unreadNotifications').textContent = data.unread_count;
                    renderNotifications(data.notifications);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Render notifications
        function renderNotifications(notifications) {
            const container = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-bell-slash" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map(notification => {
                const customer = notification.customer;
                const order = notification.order;
                const totals = notification.totals;
                const time = new Date(notification.timestamp).toLocaleString();
                const paymentMethod = customer.paymentMethod === 'phonepe' ? 'PhonePe' : 
                                    customer.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Pay in App';

                const orderItemsHtml = order.items.map(item => {
                    if (item.quantity_grams) {
                        // Gram-based item
                        return `
                            <div class="order-item">
                                <div class="item-info">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-details">
                                        Base Weight: ${item.weight || 'N/A'} | Ordered: ${item.quantity_grams}g
                                    </div>
                                </div>
                                <div class="item-quantity-price">
                                    ${item.quantity_grams}g<br>
                                    ₹${item.total_price.toFixed(2)}
                                </div>
                            </div>
                        `;
                    } else {
                        // Regular quantity-based item
                        return `
                            <div class="order-item">
                                <div class="item-info">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-details">
                                        Weight: ${item.weight || 'N/A'} | Price: ₹${item.price} each
                                    </div>
                                </div>
                                <div class="item-quantity-price">
                                    Qty: ${item.quantity}<br>
                                    ₹${(item.price * item.quantity).toFixed(2)}
                                </div>
                            </div>
                        `;
                    }
                }).join('');

                return `
                    <div class="notification-item ${notification.read ? '' : 'unread'}">
                        <div class="notification-header">
                            <div class="notification-title">
                                <i class="fas fa-shopping-cart"></i>
                                New Order Received
                            </div>
                            <div>
                                <span class="notification-time">${time}</span>
                                ${!notification.read ? `<button class="mark-read-btn" onclick="markNotificationRead('${notification.id}')">Mark Read</button>` : ''}
                            </div>
                        </div>
                        <div class="notification-content">
                            <div class="notification-customer">
                                <h4><i class="fas fa-user"></i> Customer Details</h4>
                                <div class="notification-detail"><strong>Name:</strong> ${customer.name}</div>
                                <div class="notification-detail"><strong>Mobile:</strong> ${customer.mobile}</div>
                                <div class="notification-detail"><strong>Address Type:</strong> ${customer.addressType}</div>
                                <div class="notification-detail"><strong>Location:</strong> ${customer.blockFlat}</div>
                                <div class="notification-detail"><strong>Full Address:</strong> ${customer.fullAddress}</div>
                            </div>
                            <div class="notification-order">
                                <h4><i class="fas fa-receipt"></i> Order Summary</h4>
                                <div class="notification-detail"><strong>Order ID:</strong> ${order.id.substr(0,8)}</div>
                                <div class="notification-detail"><strong>Items:</strong> ${order.items.length} products</div>
                                <div class="notification-detail"><strong>Subtotal:</strong> ₹${totals.subtotal}</div>
                                <div class="notification-detail"><strong>Delivery:</strong> ${totals.deliveryText}</div>
                                <div class="notification-detail"><strong>Payment:</strong> ${paymentMethod}</div>
                                <div class="notification-total">Total: ₹${totals.total}</div>
                                
                                <div class="order-items-section" id="items-${notification.id}" style="display: none;">
                                    <div class="order-items-header">
                                        <i class="fas fa-list"></i>
                                        Ordered Items
                                    </div>
                                    ${orderItemsHtml}
                                </div>
                                
                                <button class="view-details-btn" onclick="toggleOrderDetails('${notification.id}')">
                                    <i class="fas fa-eye"></i> View Order Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle notifications panel
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                panel.scrollIntoView({ behavior: 'smooth' });
            } else {
                panel.style.display = 'none';
            }
        }

        // Mark single notification as read
        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch(`/api/admin/notifications/${notificationId}/read`, {
                    method: 'PUT'
                });

                const data = await response.json();
                if (data.success) {
                    loadNotifications(); // Refresh notifications
                    showNotification('Notification marked as read', 'success');
                } else {
                    showNotification(data.error || 'Error marking notification as read', 'error');
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                showNotification('Error marking notification as read', 'error');
            }
        }

        // Mark all notifications as read
        async function markAllNotificationsRead() {
            try {
                const response = await fetch('/api/admin/notifications');
                const data = await response.json();
                
                if (data.success && data.notifications.length > 0) {
                    // Mark all unread notifications as read
                    const unreadNotifications = data.notifications.filter(n => !n.read);
                    
                    for (const notification of unreadNotifications) {
                        await fetch(`/api/admin/notifications/${notification.id}/read`, {
                            method: 'PUT'
                        });
                    }
                    
                    loadNotifications(); // Refresh notifications
                    showNotification('All notifications marked as read', 'success');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showNotification('Error marking notifications as read', 'error');
            }
        }

        // Toggle order details visibility
        function toggleOrderDetails(notificationId) {
            const detailsSection = document.getElementById(`items-${notificationId}`);
            const button = event.target.closest('button');
            
            if (detailsSection.style.display === 'none') {
                detailsSection.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Order Details';
            } else {
                detailsSection.style.display = 'none';
                button.innerHTML = '<i class="fas fa-eye"></i> View Order Details';
            }
        }

        // Render products table
        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            products.forEach(product => {
                const row = document.createElement('tr');
                
                // Determine stock status
                let stockClass = 'stock-high';
                if (product.stock < 5) stockClass = 'stock-low';
                else if (product.stock < 20) stockClass = 'stock-medium';

                const isVisible = product.visible !== false;
                const visibilityClass = isVisible ? 'visible' : 'hidden';
                const visibilityIcon = isVisible ? 'fas fa-eye' : 'fas fa-eye-slash';
                const visibilityText = isVisible ? 'Visible' : 'Hidden';

                row.innerHTML = `
                    <td><img src="${product.image}" alt="${product.name}" class="product-image"></td>
                    <td class="product-name">${product.name}</td>
                    <td>${product.category.charAt(0).toUpperCase() + product.category.slice(1)}</td>
                    <td class="product-price">₹${product.price}</td>
                    <td class="product-stock ${stockClass}">${product.stock}</td>
                    <td>${product.rating} ⭐</td>
                    <td class="visibility-status ${visibilityClass}">
                        <button class="action-btn ${isVisible ? 'visible-btn' : 'hidden-btn'}" onclick="toggleProductVisibility(${product.id})" title="Toggle Visibility">
                            <i class="${visibilityIcon}"></i> ${visibilityText}
                        </button>
                    </td>
                    <td class="product-actions">
                        <button class="action-btn edit-btn" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Open add product modal
        function openAddProductModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';
            document.getElementById('submitBtn').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').style.display = 'block';
        }

        // Edit product
        function editProduct(productId) {
            const product = products.find(p => p.id === String(productId));
            if (!product) return;

            editingProductId = productId;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('submitBtn').textContent = 'Update Product';
            
            // Fill form with product data
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productWeight').value = product.weight; // Added
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productRating').value = product.rating; // Added
            document.getElementById('quantityType').value = product.quantity_type || 'grams'; // Added
            document.getElementById('minQuantity').value = product.min_quantity || 1; // Added
            document.getElementById('maxQuantity').value = product.max_quantity || 100; // Added
            document.getElementById('productImage').value = product.image;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productVisible').checked = product.visible !== false;
            
            document.getElementById('productModal').style.display = 'block';
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                const response = await fetch(`/api/admin/products/${productId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Product deleted successfully', 'success');
                    await loadProducts();
                    await loadStats();
                } else {
                    showNotification(data.error || 'Error deleting product', 'error');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification('Error deleting product', 'error');
            }
        }

        // Toggle product visibility
        async function toggleProductVisibility(productId) {
            try {
                const response = await fetch(`/api/admin/products/${productId}/toggle-visibility`, {
                    method: 'PUT'
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    await loadProducts();
                    await loadStats();
                } else {
                    showNotification(data.error || 'Error toggling product visibility', 'error');
                }
            } catch (error) {
                console.error('Error toggling product visibility:', error);
                showNotification('Error toggling product visibility', 'error');
            }
        }

        // Close product modal
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            editingProductId = null;
        }

        // Handle form submission
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                rating: parseFloat(document.getElementById('productRating').value),
                image: document.getElementById('productImage').value,
                description: document.getElementById('productDescription').value,
                visible: document.getElementById('productVisible').checked,
                weight: document.getElementById('productWeight').value, // Added
                quantity_type: document.getElementById('quantityType').value, // Added
                min_quantity: parseInt(document.getElementById('minQuantity').value), // Added
                max_quantity: parseInt(document.getElementById('maxQuantity').value) // Added
            };

            try {
                let response;
                if (editingProductId) {
                    // Update existing product
                    response = await fetch(`/api/admin/products/${editingProductId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Add new product
                    response = await fetch('/api/admin/products', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    closeProductModal();
                    await loadProducts();
                    await loadStats();
                } else {
                    showNotification(data.error || 'Error saving product', 'error');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showNotification('Error saving product', 'error');
            }
        });

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Orders Management Functions
        async function loadOrders() {
            try {
                const response = await fetch('/api/admin/orders');
                const data = await response.json();
                if (data.success) {
                    renderOrders(data.orders);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No orders yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => {
                const customer = order.customer_info;
                const orderDate = new Date(order.created_at).toLocaleString();
                const statusConfig = {
                    'order_received': { color: '#3498db', icon: 'fas fa-receipt', label: 'Order Received' },
                    'confirmed': { color: '#2ecc71', icon: 'fas fa-check-circle', label: 'Confirmed' },
                    'packed': { color: '#f39c12', icon: 'fas fa-box', label: 'Packed' },
                    'out_for_delivery': { color: '#e67e22', icon: 'fas fa-truck', label: 'Out for Delivery' },
                    'delivered': { color: '#27ae60', icon: 'fas fa-check-double', label: 'Delivered' },
                    'cancelled': { color: '#e74c3c', icon: 'fas fa-times-circle', label: 'Cancelled' }
                };

                const currentStatus = statusConfig[order.status] || { color: '#95a5a6', icon: 'fas fa-info', label: order.status };

                const orderItemsHtml = order.items.map(item => `
                    <div class="order-item">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">
                                Qty: ${item.quantity} ${item.weight ? `(${item.weight}g each)` : ''}
                            </div>
                        </div>
                        <div class="item-quantity-price">
                            ₹${item.price}
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="admin-order-card" style="border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; background: white; overflow: hidden;">
                        <div class="admin-order-header" style="background: ${currentStatus.color}; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; font-size: 1.1rem;">Order #${order.id.substr(-8)}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">${orderDate}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="${currentStatus.icon}"></i>
                                ${currentStatus.label}
                            </div>
                        </div>
                        <div class="admin-order-body" style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <h4 style="margin-bottom: 10px; color: #2c3e50;"><i class="fas fa-user"></i> Customer Details</h4>
                                    <p><strong>Name:</strong> ${customer.name}</p>
                                    <p><strong>Mobile:</strong> ${customer.mobile}</p>
                                    <p><strong>Address:</strong> ${customer.fullAddress}</p>
                                    <p><strong>Payment:</strong> ${order.payment_method === 'cod' ? 'Cash on Delivery' : order.payment_method.toUpperCase()}</p>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 10px; color: #2c3e50;"><i class="fas fa-box"></i> Order Items</h4>
                                    <div style="max-height: 150px; overflow-y: auto;">
                                        ${orderItemsHtml}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="border-top: 1px solid #eee; padding-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 1.2rem; color: #2ecc71;">Total: ₹${order.total}</strong>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                        Items: ${order.items.length} | Delivery: ${order.estimated_delivery_text}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <select id="status-${order.id}" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="order_received" ${order.status === 'order_received' ? 'selected' : ''}>Order Received</option>
                                        <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                        <option value="packed" ${order.status === 'packed' ? 'selected' : ''}>Packed</option>
                                        <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Out for Delivery</option>
                                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                    <input type="number" id="time-${order.id}" placeholder="Minutes" value="${order.estimated_delivery_minutes || 60}" 
                                           style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <button onclick="updateOrderStatus('${order.id}')" 
                                            style="background: #2ecc71; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                        <i class="fas fa-save"></i> Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateOrderStatus(orderId) {
            const statusSelect = document.getElementById(`status-${orderId}`);
            const timeInput = document.getElementById(`time-${orderId}`);
            const newStatus = statusSelect.value;
            const estimatedMinutes = parseInt(timeInput.value) || 60;

            try {
                const response = await fetch(`/api/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        estimated_minutes: estimatedMinutes
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    await loadOrders(); // Refresh orders
                } else {
                    showNotification(data.error || 'Error updating order', 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Error updating order status', 'error');
            }
        }

        function refreshOrders() {
            loadOrders();
        }

        // Load orders when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target === modal) {
                closeProductModal();
            }
        }

        // Function to update quantity limits based on selected quantity type
        function updateQuantityLimits() {
            const quantityType = document.getElementById('quantityType').value;
            const minQuantityInput = document.getElementById('minQuantity');
            const maxQuantityInput = document.getElementById('maxQuantity');
            const quantityHint = document.getElementById('quantityHint');

            if (quantityType === 'grams') {
                minQuantityInput.setAttribute('placeholder', 'Min order quantity (KG)');
                maxQuantityInput.setAttribute('placeholder', 'Max order quantity (KG)');
                quantityHint.textContent = 'Minimum quantity customers can order (KG)';
                // Set default values for KG
                minQuantityInput.value = minQuantityInput.value || 0.25;
                maxQuantityInput.value = maxQuantityInput.value || 5;
            } else if (quantityType === 'pieces') {
                minQuantityInput.setAttribute('placeholder', 'Min order quantity (Numbers)');
                maxQuantityInput.setAttribute('placeholder', 'Max order quantity (Numbers)');
                quantityHint.textContent = 'Minimum quantity customers can order (Numbers)';
                // Set default values for Numbers
                minQuantityInput.value = minQuantityInput.value || 1;
                maxQuantityInput.value = maxQuantityInput.value || 20;
            }
        }
    </script>
</body>
</html> 